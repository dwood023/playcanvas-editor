<!doctype html>
<html>
<head>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            margin: 0;

            height: 100vh;
            width: 100vw;

            display: flex;
        }

        #canvas {
            width: 80%;
            height: 100%;
        }

        #sidebar {
            width: 20%;
            height: 100%;
        }

        #project-picker {
            position: relative;
            z-index: 2;
            color: white;
        }
    </style>
    <title>Template</title>
    <script src="playcanvas-stable.min.js"></script>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id='sidebar'>
        <h2>Open project</h2>
        <input id="project-picker" type='file' accept=".json" />

        <h2>Entities</h2>
        <ul id='entities'></ul>
    </div>

    <script>
        // APP
        const canvas = document.getElementById('canvas');

        // ensure canvas is resized when window changes size
        window.addEventListener('resize', () => app.resizeCanvas());

        const app = new pc.Application(canvas, {
            mouse: new pc.Mouse(canvas),
        });

        // fill the available space at full resolution
        app.setCanvasFillMode(pc.FILLMODE_NONE);
        app.setCanvasResolution(pc.RESOLUTION_AUTO);

        // SCRIPT
        const picker = new pc.Picker(app, canvas.clientWidth, canvas.clientHeight);

        const loadProject = (name) => {
            app.loadScene(name, () => {
                app.start();
                const entity_list = document.getElementById('entities');

                while (entity_list.lastChild) entity_list.lastChild.remove();

                for (let child of app.scene.root.children) {
                    const entity = document.createElement('li');
                    entity.innerText = child.name;
                    entity_list.appendChild(entity);

                    // TODO: Should re-prepare whenever active camera in scene changes
                    if ('camera' in child) {
                        picker.prepare(child.camera, app.scene);
                    }
                }
            });
        };

        const project_picker = document.getElementById("project-picker");
        project_picker.onchange = (e) => {
            const [file] = e.target.files;

            loadProject(file.name);
        };

        loadProject('1305520.json');

        app.mouse.on(pc.EVENT_MOUSEDOWN, (e) => {
            // console.info(e);
            const { x, y } = e;
            const selection = picker.getSelection(x, y);
            const [mesh] = selection;

            const position = mesh.node.getPosition();
            console.info('Here is the position of the mesh you clicked: ', position);
        });

    </script>
</body>
</html>
